import os
import telebot
import subprocess
import time
import logging
import random
import threading
from flask import Flask
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
BOT_TOKEN = os.getenv('BOT_TOKEN', '8215456582:AAHFB0z4Gx3ANHgVNOOm1XgvBPMmlQHEO6A')
ADMIN_ID = 6689435577
BOT_USERNAME = '@HOZ7_BOT'

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª
UPLOAD_DIR = 'uploaded_files'
os.makedirs(UPLOAD_DIR, exist_ok=True)

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©
active_processes = {}

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(BOT_TOKEN)

# Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Flask Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚Ù‚
app = Flask(__name__)

@app.route('/')
def health_check():
    return "Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ âœ…", 200

@app.route('/status')
def status_check():
    return "Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: Ù†Ø´Ø· ğŸŸ¢", 200

# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ÙØ° Ù…Ù† Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ø£Ùˆ 10000 Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
port = int(os.environ.get('PORT', 10000))

def run_flask():
    app.run(host='0.0.0.0', port=port, debug=False)

# Ø¨Ø¯Ø¡ Flask ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
flask_thread = threading.Thread(target=run_flask)
flask_thread.daemon = True
flask_thread.start()

# Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø¥Ù†Ù„Ø§ÙŠÙ† Ù…Ø¹ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
def create_inline_keyboard(with_back_button=True):
    keyboard = InlineKeyboardMarkup(row_width=2)
    buttons = [
        InlineKeyboardButton('ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù', callback_data='upload_file'),
        InlineKeyboardButton('âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', callback_data='settings'),
        InlineKeyboardButton('ğŸ¤– Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ AI', callback_data='ai_chat'),
        InlineKeyboardButton('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª', callback_data='status')
    ]
    
    keyboard.add(buttons[0], buttons[1])
    keyboard.add(buttons[2], buttons[3])
    
    if with_back_button:
        keyboard.add(InlineKeyboardButton('ğŸ”™ Ø±Ø¬ÙˆØ¹', callback_data='main_menu'))
    
    return keyboard

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    chat_id = message.chat.id
    
    welcome_text = """
Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ø³ØªØ¶Ø§ÙØ© Ø¨Ø§ÙŠØ«ÙˆÙ†

Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
- Ø±ÙØ¹ ÙˆØªØ´ØºÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
- Ø¯Ø¹Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©

Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø§ÙŠØ«ÙˆÙ†

Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
Ø§ÙƒØªØ¨ /help Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙˆØ·
"""
    bot.send_message(chat_id, welcome_text, reply_markup=create_inline_keyboard())

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /help
@bot.message_handler(commands=['help'])
def help_command(message):
    chat_id = message.chat.id
    
    help_text = """
Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

1. ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† py
2. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù 20MB
3. ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù‚ØµÙ‰ 30 Ø«Ø§Ù†ÙŠØ©
4. ÙŠÙ…Ù†Ø¹ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙƒÙˆØ§Ø¯ Ø¶Ø§Ø±Ø©

Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù…
{}
""".format(BOT_USERNAME)
    
    bot.send_message(chat_id, help_text, reply_markup=create_inline_keyboard())

# Ù…Ø¹Ø§Ù„Ø¬Ø© callback queries
@bot.callback_query_handler(func=lambda call: True)
def handle_callback_query(call):
    chat_id = call.message.chat.id
    message_id = call.message.message_id
    data = call.data
    
    if data == 'upload_file':
        bot.edit_message_text(
            "Ø£Ø±Ø³Ù„ Ù„ÙŠ Ù…Ù„Ù Ø¨Ø§ÙŠØ«ÙˆÙ† py Ù„Ø±ÙØ¹Ù‡ ÙˆØªØ´ØºÙŠÙ„Ù‡",
            chat_id,
            message_id,
            reply_markup=create_inline_keyboard()
        )
    
    elif data == 'settings':
        settings_text = """
Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©

- Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©
- ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©
- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨ÙˆØª
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
"""
        bot.edit_message_text(
            settings_text,
            chat_id,
            message_id,
            reply_markup=create_inline_keyboard()
        )
    
    elif data == 'ai_chat':
        bot.edit_message_text(
            "Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹. Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹.",
            chat_id,
            message_id,
            reply_markup=create_inline_keyboard()
        )
    
    elif data == 'status':
        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
        file_count = len([f for f in os.listdir(UPLOAD_DIR) if os.path.isfile(os.path.join(UPLOAD_DIR, f))])
        active_count = len(active_processes)
        
        status_text = """
Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª

Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©: {}
Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©: {}
Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
""".format(file_count, active_count)
        
        bot.edit_message_text(
            status_text,
            chat_id,
            message_id,
            reply_markup=create_inline_keyboard()
        )
    
    elif data == 'main_menu':
        welcome_text = """
Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ø³ØªØ¶Ø§ÙØ© Ø¨Ø§ÙŠØ«ÙˆÙ†

Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
- Ø±ÙØ¹ ÙˆØªØ´ØºÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
- Ø¯Ø¹Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©

Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø§ÙŠØ«ÙˆÙ†
"""
        bot.edit_message_text(
            welcome_text,
            chat_id,
            message_id,
            reply_markup=create_inline_keyboard(with_back_button=False)
        )
    
    # Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ callback query Ù„Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    bot.answer_callback_query(call.id)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
@bot.message_handler(content_types=['document'])
def handle_document(message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù
        if not message.document.file_name.endswith('.py'):
            bot.send_message(chat_id, "ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† py", reply_markup=create_inline_keyboard())
            return
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        file_info = bot.get_file(message.document.file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        file_name = message.document.file_name
        
        # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
        file_path = os.path.join(UPLOAD_DIR, f"{user_id}_{file_name}")
        with open(file_path, 'wb') as new_file:
            new_file.write(downloaded_file)
        
        # Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
        file_size = len(downloaded_file) / (1024 * 1024)  # MB
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
        bot.send_message(
            chat_id, 
            f"ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­: {file_name} ({file_size:.2f} MB)",
            reply_markup=create_inline_keyboard()
        )
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        process = subprocess.Popen(
            ['python', file_path],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )
        
        # ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        process_key = f"{user_id}_{file_name}"
        active_processes[process_key] = {
            'process': process,
            'start_time': time.time(),
            'chat_id': chat_id
        }
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ù… Ø¬Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        time.sleep(2)
        stdout, stderr = process.communicate()
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        result = f"Ù†ØªÙŠØ¬Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù: {file_name}\n\n"
        
        if stdout:
            result += f"Ø§Ù„Ù†Ø§ØªØ¬:\n{stdout}\n"
        
        if stderr:
            result += f"Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:\n{stderr}\n"
        
        if not stdout and not stderr:
            result += "ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† Ù†Ø§ØªØ¬.\n"
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        bot.send_message(
            chat_id,
            result,
            reply_markup=create_inline_keyboard()
        )
        
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        if process_key in active_processes:
            del active_processes[process_key]
    
    except Exception as e:
        logging.error(f"Error uploading file: {str(e)}")
        bot.send_message(
            chat_id, 
            f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: {str(e)}",
            reply_markup=create_inline_keyboard()
        )

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == '__main__':
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù…Ø¹ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©!")
    print(f"ğŸ“Š Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…ØªØ§Ø­Ø© Ø¹Ù„Ù‰: http://0.0.0.0:{port}/")
    bot.infinity_polling()
